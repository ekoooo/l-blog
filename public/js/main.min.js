!function(i){i.fn.message=function(t,e){var a="emoji";2===e?a="warning":3===e&&(a="delete");var n=i('<span class="message"><i class="iconfont icon-'+a+'"></i> '+t+"</span>");i("body").append(n),n.animate({opacity:1,top:"40%"},{duration:300,done:function(){setTimeout(function(){n.animate({opacity:0,top:"0"},{duration:500,easing:"swing",done:function(){n.remove()}})},2e3)}})}}(jQuery),$(function(){function t(){var h=this;this.listLoading=!1;function p(t){function e(t){return""===t||null==t}var a,n;return e(t.postId)?"参数错误":e(t.name)?"请输入昵称":e(t.mail)?"请输入邮箱":e($.trim(t.content))?"请输入内容":t.name.length<2||16<t.name.length?"昵称必须 2 到 16 位":e(t.mail)||(a=t.mail,/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(a.toLowerCase()))?!e(t.site)&&(n=t.site,!/^(?:\w+:)?\/\/([^\s\.]+\.\S{2}|localhost[\:?\d]*)\S*$/.test(n))&&"网址格式不正确":"邮箱格式不正确"}var e="#comment-tool",u="#post-id",f="#parent-id",g="#reply-id",a="#author-name",n="#author-mail",o="#author-site",s="#md-editor",v="#send-comment",k="#load-editor",y=".comment-more",b=".reply-button";this.initEditor=function(){function l(){$("#parent-id").val(null),$("#reply-id").val(null),$(".comment-container").removeClass("fixed"),m&&m.resize("200%")}var r,c,d,t,m=null,i=$(e);i.length&&(r=$(a),c=$(n),d=$(o),!window.localStorage||(t=JSON.parse(window.localStorage.getItem("comment_info")))&&(r.val(t.name),c.val(t.mail),d.val(t.site)),$(v).on("click",function(t){t.preventDefault();var e=$(this),a=e.val();e.attr("disabled",!0).val("发送中...");var n,i,o,s={postId:$(u).val(),parentId:$(f).val(),replyId:$(g).val(),name:r.val(),mail:c.val(),site:d.val(),content:m&&m.getPreviewedHTML()};i=function(t){e.attr("disabled",!1).val(a),t&&(200===t.code?(t.info.commentCheck?$().message("评论成功，需管理员审核才能展示"):($().message("评论成功"),h.initCommentList(!0)),m.setMarkdown(""),l(),window.localStorage&&window.localStorage.setItem("comment_info",JSON.stringify({name:s.name,mail:s.mail,site:s.site}))):$().message(t.message))},(o=p(n=s))?($().message(o),i(!1)):$.ajax({url:"/comment",method:"POST",data:n,dataType:"json",success:function(t){i(t)},error:function(){i(!1)}})}),$(k).on("click",function(n){var t,e;n.preventDefault(),$(n.currentTarget).val("正在加载编辑器..."),t=function(){var t,e;t=function(){var t,e,a;t=function(t){$(n.currentTarget).hide(),$().message("编辑器加载成功"),$("html, body").animate({scrollTop:i.offset().top-70+"px"},{duration:500,easing:"swing"}),m=t},e=s,(a=window.editormd(e.replace("#",""),{width:"100%",height:150,path:"/manager/static/editor.md/lib/",placeholder:"请输入留言，支持 Markdown...",lineNumbers:!1,saveHTMLToTextarea:!0,watch:!0,toolbar:!1,taskList:!0})).on("load",function(){t&&t(a),this.resize("200%",null)})},(e=document.createElement("script")).type="text/javascript",e.src="/manager/static/editor.md/editormd.min.js",e.onload=e.onreadystatechange=function(){t&&t()},document.body.appendChild(e)},(e=document.createElement("link")).type="text/css",e.rel="stylesheet",e.href="/manager/static/editor.md/css/editormd.min.css",e.onload=e.onreadystatechange=function(){t&&t()},$(e).insertAfter($("title"))}),$(o).on("blur",function(){var t=$(this).val();0<t.length&&0!==t.indexOf("http://")&&0!==t.indexOf("https://")&&0!==t.indexOf("tfp://")&&$(this).val("http://"+t)}),$(y).on("click",function(){h.listLoading||(h.listLoading=!0,h.initCommentList())}),$(".comment-list").on("click",b,function(t){var e,a;e=this.dataset.parentId,a=this.dataset.replyId,$("#parent-id").val(e),$("#reply-id").val(a),$(".comment-container").addClass("fixed"),m&&m.resize("200%")}),$(".comment-container").on("click",function(t){$(t.target).hasClass("comment-container")&&l()}))},this.initCommentList=function(m){var t,e,p,u,f=$(".comment-info");f.length&&(t=f.attr("data-post-id"),e=f.attr("data-page"),p=$(y),u=p.text(),p.text("加载中..."),m&&(e=-1),$.ajax({url:"/comment?page="+ ++e+"&postId="+t,method:"GET",dataType:"json",success:function(t){if(200===t.code){var e=t.pageSize,a=t.list,n=parseInt((t.totalCount+e-1)/e);f.attr("data-page",t.pageId),n<=t.pageId+1?p.hide():p.show(),$(".comment-info-count").text(t.totalCount);var i=$(".comment-list"),o=void 0;m?(i.empty(),o=0,f.attr("data-count",a.length)):(o=Number(f.attr("data-count")),f.attr("data-count",o+a.length));for(var s=0;s<a.length;s++){for(var l,r=a[s],c="",d=0;d<r.childList.length;d++)c+='<li class="comment-list-item" id="post-comment-'+(l=r.childList[d]).post_id+'">  <div>    <p class="head">      <span class="name"><a target="_blank" href="'+l.author_site+'">'+l.author+'</a></span>      <span>回复</span>      <span class="name"><a target="_blank" href="'+l.reply_to_author_site+'">'+l.reply_to_author+'</a></span>      <span>于</span>      <span class="time">'+l.create_time+'</span>    </p>    <div class="content markdown-body">'+l.content+'</div>    <span data-parent-id="'+r.id+'" data-reply-id="'+l.id+'" class="reply-button">回复TA</span>  </div></li>';c.length&&(c='<ul class="comment-list-child">'+c+"</ul>"),i.append('<li class="comment-list-item" id="post-comment-'+r.post_id+'">  <div>    <p class="head">      <span class="name"><a target="_blank" href="'+r.author_site+'">'+(o+s+1)+"# "+r.author+'</a></span>      <span>于</span>      <span class="time">'+r.create_time+'</span>      <span>回复：</span>    </p>    <div class="content markdown-body">'+r.content+'</div>    <span class="reply-button" data-parent-id="'+r.id+'" data-reply-id="'+r.id+'">回复TA</span>  </div>'+c+"</li>")}}h.listLoading=!1,p.text(u)}}))}}var e,a;$(".markdown-toc a").on("click",function(t){t.preventDefault();var e=decodeURI(this.href.split("#")[1]);$("html, body").animate({scrollTop:$('.reference-link[name="'+e+'"]').offset().top-70+"px"},{duration:500,easing:"swing"})}),e=$(".post-box").attr("data-post-id"),$(".post-vote .post-vote-item").on("click",function(){var n,i;$(".post-vote-item i.active").length?$().message("您已投过票了！"):(i=$(n=this).hasClass("unlike"),$.ajax({type:"POST",url:(i?"/post/unlike/":"/post/like/")+e,success:function(t){var e,a;200===t.code?(e=$(n).find("i"),a=i?$(".unlike-num"):$(".like-num"),i?e.removeClass("icon-emoji").addClass("pink active icon-emoji_fill"):e.removeClass("icon-praise").addClass("pink active icon-praise_fill"),a.text(Number(a.eq(0).text())+1),$().message("投票成功！")):$().message(t.message)},dataType:"json"}))}),$('.markdown-body a:not([class^="toc-level"])').attr("target","_blank"),$(".sidebar-op").on("click",function(){var o=$(".sidebar");o.attr("data-init")||$.ajax({method:"GET",url:"/sidebar",dataType:"json",success:function(t){if(200===t.code){var e=t.info;$(".author-ch-name").text(e.ch_name),$(".author-en-name").text(e.en_name),$(".collection-post-num").text(e.post_num),$(".collection-category-num").text(e.post_category_num),$(".collection-tag-num").text(e.post_tag_num);for(var a=$(".author-links"),n=0;n<e.links.length;n++)a.append('<a target="_blank" href="'+e.links[n].href+'">'+e.links[n].label+"</a>");for(var i=$(".friends-links"),n=0;n<e.friends_links.length;n++)i.append('<a target="_blank" href="'+e.friends_links[n].href+'">'+e.friends_links[n].label+"</a>");o.attr("data-init","1")}else $.message(t.message)}}),$("body").toggleClass("sidebar-open")}),$(".sidebar .author-avatar img").on("mouseover mouseleave",function(t){$(this).attr("src","mouseover"===t.type?"/img/logo.gif":"/img/logo_1.png")}),$(".nav .switch").on("click",function(){$(this).parent().toggleClass("active")}),(a=new t).initEditor(),a.initCommentList(!0)});
//# sourceMappingURL=main.min.js.map
